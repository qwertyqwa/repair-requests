{% extends "base.html" %}
{% set title = "Заявка №" ~ request_obj.number %}

{% block content %}
  <div class="pagehead">
    <h1>Заявка №{{ request_obj.number }}</h1>
    <div class="pagehead__actions">
      <a class="btn" href="{{ url_for('web.index') }}">Назад</a>
      {% if can_manage %}
        <a class="btn btn--primary" href="{{ url_for('web.request_edit', number=request_obj.number) }}">Редактировать</a>
        <form method="post" action="{{ url_for('web.request_delete', number=request_obj.number) }}" class="inline" data-confirm="Удалить заявку №{{ request_obj.number }}?">
          <button class="btn btn--danger" type="submit">Удалить</button>
        </form>
      {% endif %}
      {% if is_master %}
        <a class="btn btn--primary" href="{{ url_for('web.request_work', number=request_obj.number) }}">В работу</a>
      {% endif %}
    </div>
  </div>

  <div class="card">
    <div class="card__row">
      <div class="card__item">
        <div class="muted">Дата добавления</div>
        <div>{{ request_obj.created_at|dt }}</div>
      </div>
      <div class="card__item">
        <div class="muted">Статус</div>
        <div>{{ request_obj.status|status_label }}</div>
      </div>
      <div class="card__item">
        <div class="muted">Ответственный мастер</div>
        <div>{{ request_obj.technician_username or "—" }}</div>
      </div>
    </div>

    <div class="card__row">
      <div class="card__item">
        <div class="muted">Техника</div>
        <div>{{ request_obj.appliance_type }} — {{ request_obj.appliance_model }}</div>
      </div>
      <div class="card__item">
        <div class="muted">Тип неисправности</div>
        <div>{{ request_obj.issue_type or "—" }}</div>
      </div>
    </div>

    <div class="card__row">
      <div class="card__item">
        <div class="muted">Клиент</div>
        <div>{{ request_obj.client_name }}</div>
      </div>
      <div class="card__item">
        <div class="muted">Телефон</div>
        <div>{{ request_obj.client_phone }}</div>
      </div>
    </div>

    <div class="card__block">
      <div class="muted">Описание проблемы</div>
      <div class="pre">{{ request_obj.problem_description }}</div>
    </div>
  </div>

  <div class="card">
    <h2 class="h2">Комплектующие</h2>
    {% if parts %}
      <ul class="list">
        {% for p in parts %}
          <li class="list__item">
            <div class="stack">
              <div><strong>{{ p.part_name }}</strong> × {{ p.quantity }}</div>
              <div class="muted">{{ p.created_at|dt }}</div>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="muted">Комплектующих пока нет.</p>
    {% endif %}
    {% if is_master %}
      <div class="form__actions">
        <a class="btn" href="{{ url_for('web.request_work', number=request_obj.number) }}">Добавить комплектующую</a>
      </div>
    {% endif %}
  </div>

  <div class="card">
    <h2 class="h2">Комментарии</h2>
    {% if comments %}
      <ul class="list">
        {% for c in comments %}
          <li class="list__item">
            <div class="stack">
              <div><strong>{{ c.author_username }}</strong> <span class="muted">— {{ c.created_at|dt }}</span></div>
              <div class="pre">{{ c.body }}</div>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="muted">Комментариев пока нет.</p>
    {% endif %}

    <form class="form" method="post" action="{{ url_for('web.request_add_comment', number=request_obj.number) }}">
      <label class="field field--full">
        <span class="field__label">Новый комментарий</span>
        <textarea class="field__input" name="body" rows="3"></textarea>
      </label>
      <div class="form__actions">
        <button class="btn btn--primary" type="submit">Добавить</button>
      </div>
    </form>
  </div>

  <div class="card">
    <h2 class="h2">История статусов</h2>
    {% if history %}
      <ul class="list">
        {% for h in history %}
          <li class="list__item">
            <div class="stack">
              <div>
                {% if h.old_status %}
                  {{ h.old_status|status_label }} → {{ h.new_status|status_label }}
                {% else %}
                  {{ h.new_status|status_label }}
                {% endif %}
              </div>
              <div class="muted">{{ h.changed_by_username }} — {{ h.changed_at|dt }}</div>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="muted">История пока пуста.</p>
    {% endif %}
  </div>
{% endblock %}
