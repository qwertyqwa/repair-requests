{% extends "base.html" %}
{% set title = "Работа по заявке №" ~ request_obj.number %}

{% block content %}
  <div class="pagehead">
    <h1>Заявка №{{ request_obj.number }} — работа мастера</h1>
    <div class="pagehead__actions">
      <a class="btn" href="{{ url_for('web.request_detail', number=request_obj.number) }}">Назад</a>
    </div>
  </div>

  <div class="card">
    <div class="card__row">
      <div class="card__item">
        <div class="muted">Техника</div>
        <div>{{ request_obj.appliance_type }} — {{ request_obj.appliance_model }}</div>
      </div>
      <div class="card__item">
        <div class="muted">Клиент</div>
        <div>{{ request_obj.client_name }}</div>
      </div>
      <div class="card__item">
        <div class="muted">Текущий статус</div>
        <div>{{ request_obj.status|status_label }}</div>
      </div>
    </div>

    <div class="card__block">
      <div class="muted">Описание проблемы</div>
      <div class="pre">{{ request_obj.problem_description }}</div>
    </div>
  </div>

  <form class="form" method="post" action="{{ url_for('web.request_work_update', number=request_obj.number) }}">
    <div class="grid">
      <label class="field">
        <span class="field__label">Новый статус</span>
        {% set current_status = form_data.get('status', request_obj.status.value) %}
        <select class="field__input" name="status">
          <option value="" {% if not current_status %}selected{% endif %}>—</option>
          {% for value, label in status_choices %}
            <option value="{{ value }}" {% if current_status == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
        {% if errors.get('status') %}<span class="field__error">{{ errors.get('status') }}</span>{% endif %}
      </label>

      <label class="field field--full">
        <span class="field__label">Комментарий мастера</span>
        <textarea class="field__input" name="master_notes" rows="4">{{ form_data.get('master_notes', request_obj.master_notes) }}</textarea>
      </label>

      <label class="field field--full">
        <span class="field__label">Запчасти/материалы</span>
        <textarea class="field__input" name="parts_notes" rows="4">{{ form_data.get('parts_notes', request_obj.parts_notes) }}</textarea>
      </label>
    </div>

    <div class="form__actions">
      <button class="btn btn--primary" type="submit">Сохранить</button>
      <a class="btn" href="{{ url_for('web.request_detail', number=request_obj.number) }}">Отмена</a>
    </div>
  </form>
{% endblock %}

